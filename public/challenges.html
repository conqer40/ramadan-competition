<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - Ø±Ù…Ø¶Ø§Ù†Ùƒ Ø¹Ù†Ø¯Ù†Ø§</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .challenges-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .challenges-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .challenges-title {
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .challenges-subtitle {
            color: var(--text-muted);
        }

        .today-challenge {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(74, 26, 122, 0.25));
            border: 2px solid var(--gold);
            border-radius: 25px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .challenge-badge {
            display: inline-block;
            background: var(--gold);
            color: #000;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .challenge-emoji {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        .challenge-text {
            font-size: 1.5rem;
            color: var(--text-white);
            margin-bottom: 1rem;
        }

        .challenge-reward {
            color: var(--gold);
            font-size: 1rem;
        }

        .complete-btn {
            margin-top: 1.5rem;
            padding: 1rem 3rem;
            font-size: 1.1rem;
        }

        .complete-btn.done {
            background: #4ade80;
            border-color: #4ade80;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .challenges-list {
            display: grid;
            gap: 1rem;
        }

        .challenge-item {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .challenge-item.completed {
            opacity: 0.6;
        }

        .challenge-item.completed .challenge-day {
            background: #4ade80;
            border-color: #4ade80;
        }

        .challenge-day {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--gold);
        }

        .challenge-info {
            flex: 1;
        }

        .challenge-name {
            font-weight: 600;
            color: var(--text-white);
        }

        .challenge-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .back-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
    </style>
</head>

<body>
    <a href="/" class="btn btn-outline back-btn"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

    <div class="challenges-container">
        <div class="challenges-header">
            <h1 class="challenges-title">ğŸ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
            <p class="challenges-subtitle">ØªØ­Ø¯Ù‰ Ù†ÙØ³Ùƒ ÙƒÙ„ ÙŠÙˆÙ… ÙÙŠ Ø±Ù…Ø¶Ø§Ù†</p>
        </div>

        <div id="today-challenge"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="completed-count">0</div>
                <div class="stat-label">ØªØ­Ø¯ÙŠ Ù…ÙƒØªÙ…Ù„</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="points">0</div>
                <div class="stat-label">Ù†Ù‚Ø·Ø©</div>
            </div>
        </div>

        <h3 style="color:var(--gold); margin-bottom:1rem;">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</h3>
        <div class="challenges-list" id="challenges-list"></div>
    </div>

    <script>
        const API = '/api';
        let currentUser = JSON.parse(localStorage.getItem('user'));

        // Ensure user is logged in
        if (!currentUser) {
            window.location.href = '/';
        }

        let challenges = []; // Will be loaded from API

        let completedChallenges = [];

        function getDayOfRamadan() {
            const ramadanStart = new Date('2026-02-18');
            const now = new Date();
            const diff = now - ramadanStart;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1; // +1 because day 0 is day 1
            if (days < 1) return 1;
            if (days > 30) return 30;
            return days;
        }

        async function init() {
            await loadChallenges();
            await loadMyStatus();
            await loadLeaderboard();
            renderTodayChallenge();
            renderAllChallenges();
            updateStats();
        }

        async function loadChallenges() {
            try {
                const res = await fetch(`${API}/challenges`);
                challenges = await res.json();
            } catch (e) {
                console.error('Error loading challenges:', e);
            }
        }

        async function loadMyStatus() {
            try {
                const res = await fetch(`${API}/challenges/my-status/${currentUser.id}`);
                const data = await res.json();
                completedChallenges = data.completedDays || [];
            } catch (e) {
                console.error(e);
            }
        }

        function renderTodayChallenge() {
            const day = getDayOfRamadan();
            const challenge = challenges[day - 1];

            if (!challenge) {
                document.getElementById('today-challenge').innerHTML = `<p style="text-align:center; color:white;">Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…! ğŸŒ™</p>`;
                return;
            }

            const isCompleted = completedChallenges.includes(day);

            document.getElementById('today-challenge').innerHTML = `
                <div class="today-challenge">
                    <span class="challenge-badge">ğŸ¯ ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ… ${day}</span>
                    <div class="challenge-emoji">${challenge.emoji}</div>
                    <div class="challenge-text">${challenge.name}</div>
                    <div style="color:var(--text-muted); margin-bottom:0.5rem;">${challenge.desc}</div>
                    <div class="challenge-reward">ğŸ† ${challenge.points} Ù†Ù‚Ø·Ø©</div>
                    <button class="btn ${isCompleted ? 'complete-btn done' : 'btn-gold complete-btn'}" 
                        onclick="completeChallenge(${day}, ${challenge.points})" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? '<i class="fas fa-check"></i> Ù…ÙƒØªÙ…Ù„!' : 'Ø£ÙƒÙ…Ù„Øª Ø§Ù„ØªØ­Ø¯ÙŠ'}
                    </button>
                </div>
            `;
        }

        function renderAllChallenges() {
            document.getElementById('challenges-list').innerHTML = challenges.map(c => `
                <div class="challenge-item ${completedChallenges.includes(c.day) ? 'completed' : ''}">
                    <div class="challenge-day">${c.day}</div>
                    <div class="challenge-info">
                        <div class="challenge-name">${c.emoji} ${c.name}</div>
                        <div class="challenge-desc">${c.desc} â€¢ ${c.points} Ù†Ù‚Ø·Ø©</div>
                    </div>
                    ${completedChallenges.includes(c.day) ? '<i class="fas fa-check-circle" style="color:#4ade80; font-size:1.5rem;"></i>' : ''}
                </div>
            `).join('');
        }

        async function completeChallenge(day, points) {
            if (completedChallenges.includes(day)) return;

            const res = await fetch(`${API}/challenges/complete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUser.id, dayNumber: day, points })
            });

            if (res.ok) {
                completedChallenges.push(day);
                renderTodayChallenge();
                renderAllChallenges();
                updateStats();
                await loadLeaderboard(); // Refresh leaderboard
            }
        }

        function updateStats() {
            const completed = completedChallenges.length;
            const points = completedChallenges.reduce((sum, day) => {
                const c = challenges.find(ch => ch.day === day);
                return sum + (c ? c.points : 0);
            }, 0);

            // Calculate streak
            let streak = 0;
            for (let i = getDayOfRamadan(); i >= 1; i--) {
                if (completedChallenges.includes(i)) streak++;
                else break;
            }

            document.getElementById('completed-count').textContent = completed;
            document.getElementById('streak').textContent = streak;
            document.getElementById('points').textContent = points;
        }

        async function loadLeaderboard() {
            try {
                const res = await fetch(`${API}/leaderboard`);
                const data = await res.json();

                const html = `
                    <div class="stat-card" style="grid-column: 1 / -1; margin-top: 1rem; text-align: right;">
                        <h3 style="color:var(--gold); margin-bottom:1rem; text-align:center;">ğŸ† ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</h3>
                        ${data.length ? `
                            <div class="challenges-leaderboard-list">
                                ${data.map((u, i) => `
                                    <div class="challenge-item" style="padding:0.75rem;">
                                        <div class="challenge-day" style="font-size:1.2rem; width:35px; height:35px;">${i + 1}</div>
                                        <div class="challenge-info">
                                            <a href="${u.facebook_url ? u.facebook_url : 'profile.html?id=' + u.id}" 
                                               target="${u.facebook_url ? '_blank' : '_self'}"
                                               class="challenge-name" style="color:var(--gold); text-decoration:underline;">
                                                ${u.name} ${u.facebook_url ? '<i class="fab fa-facebook-f" style="font-size:0.8em; margin-right:5px;"></i>' : ''}
                                            </a>
                                        </div>
                                        <div style="font-weight:bold; color:var(--gold);">${u.score}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align:center;">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ´Ø§Ø±Ùƒ!</p>'}
                    </div>
                `;

                // Append to stats grid or creating a new section? 
                // Let's insert it after stats-grid
                let lbContainer = document.getElementById('challenges-leaderboard');
                if (!lbContainer) {
                    lbContainer = document.createElement('div');
                    lbContainer.id = 'challenges-leaderboard';
                    document.querySelector('.stats-grid').after(lbContainer);
                }
                lbContainer.innerHTML = html;

            } catch (e) { console.error('Error loading leaderboard', e); }
        }

        init();
    </script>
</body>

</html>